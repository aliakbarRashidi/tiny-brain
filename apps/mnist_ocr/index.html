<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>EM Test</title>
    <script type="text/javascript" src="mnist_ocr.js"></script>
</head>
<body>
    Guessing this picture's digits...
    <canvas id="canvas">your canvas loads here</canvas>
	<script type="text/javascript">

    var ocr_wrapper;

    function _arrayToHeap(typedArray){
        var numBytes = typedArray.length * typedArray.BYTES_PER_ELEMENT;
        var ptr = Module._malloc(numBytes);
        var heapBytes = new Uint8Array(Module.HEAPU8.buffer, ptr, numBytes);
        heapBytes.set(new Uint8Array(typedArray.buffer));
        return heapBytes;
    }

    function _freeArray(heapBytes){
        Module._free(heapBytes.byteOffset);
    }

	function allReady() {

        ocr_wrapper = new Module.ocr_wrapper;

        var canvas = document.getElementById("canvas");
        var context = canvas.getContext('2d');
        var image = new Image();

        image.onload=function(){
            context.drawImage(image,0,0,canvas.width,canvas.height);

            var numBytes = canvas.width * canvas.height * 4;
            var ptr = Module._malloc(numBytes);
            var dataTrg = new Uint8Array(Module.HEAPU8.buffer, ptr, numBytes);

            var dataSrc = context.getImageData(0,0,canvas.width,canvas.height);
            var dataTrg = _arrayToHeap(dataSrc.data);

            var image_infos = { ptr : dataTrg.byteOffset, sizeX : canvas.width, sizeY : canvas.height };

            console.log('processing...');

            ocr_wrapper.process(image_infos,onProcessed);
            ocr_wrapper.delete();

            _freeArray(dataTrg);
        };
        image.src = "123456.png";
	}

    function onProcessed() {
        console.log('processed!');
        console.log('found ' + ocr_wrapper.reco_string());
    }

	</script>
</body>
</html>
