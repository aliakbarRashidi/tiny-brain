<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>EM Test</title>
    <script type="text/javascript" src="mnist_ocr.js"></script>
</head>
<body>
    Guessing this picture's digits...
    <canvas id="canvas">your canvas loads here</canvas>
	<script type="text/javascript">

    var ocr_wrapper;

	function allReady() {

        ocr_wrapper = new Module.ocr_wrapper;

        var canvas = document.getElementById("canvas");
        var context = canvas.getContext('2d');
        var image = new Image();

        image.onload=function(){
            context.drawImage(image,0,0,canvas.width,canvas.height);

            var numBytes = canvas.width * canvas.height * 1;
            var ptr = Module._malloc(numBytes);
            //var dataTrg = new Uint8Array(Module.HEAPU8.buffer, ptr, numBytes);

            var dataSrc = context.getImageData(0,0,canvas.width,canvas.height);

            var luma;

            // convert by iterating over each pixel each representing RGBA
            for(i=0, j=0; i < canvas.width*canvas.height; i += 4, j+= 1) {
                ptr[j] = dataSrc[i] * 0.2126 + dataSrc[i+1] * 0.7152 + dataSrc[i+2] * 0.0722;
            }

            var image_infos = { ptr : ptr, sizeX : canvas.width, sizeY : canvas.height };

            console.log('processing...')

            ocr_wrapper.process(image_infos,onProcessed);
            ocr_wrapper.delete();
        };
        image.src = "123456.png";
	}

    function onProcessed() {
        console.log('processed!')
    }

	</script>
</body>
</html>
