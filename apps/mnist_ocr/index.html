<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>EM Test</title>
    <script type="text/javascript" src="mnist_ocr.js"></script>
    <style>
        .emscripten { padding-right: 0; margin-left: auto; margin-right: auto; display: block; }
        textarea.emscripten { font-family: monospace; width: 80%; }
        div.emscripten { text-align: center; }
    </style>
</head>
<body bgcolor="#EFF5FB">
    Guessing this picture's digits...
    <canvas id="canvas_ocr">your canvas loads here</canvas>
    <label id="digits"></label>

    <hr/>
    <textarea class="emscripten" id="output" rows="8"></textarea>
    <hr/>

	<script type="text/javascript">

    var ocr_wrapper;

    function _configureModule(){
        Module['print'] = (function() {
            var element = document.getElementById('output');
            if (element) element.value = ''; // clear browser cache
            return function(text) {
                if (arguments.length > 1) text = Array.prototype.slice.call(arguments).join(' ');
                // These replacements are necessary if you render to raw HTML
                //text = text.replace(/&/g, "&amp;");
                //text = text.replace(/</g, "&lt;");
                //text = text.replace(/>/g, "&gt;");
                //text = text.replace('\n', '<br>', 'g');
                console.log(text);
                if (element) {
                    element.value += text + "\n";
                    element.scrollTop = element.scrollHeight; // focus on bottom
                }
            };
        })();
    }

    function _arrayToHeap(typedArray){
        var numBytes = typedArray.length * typedArray.BYTES_PER_ELEMENT;
        var ptr = Module._malloc(numBytes);
        var heapBytes = new Uint8Array(Module.HEAPU8.buffer, ptr, numBytes);
        heapBytes.set(new Uint8Array(typedArray.buffer));
        return heapBytes;
    }

    function _freeArray(heapBytes){
        Module._free(heapBytes.byteOffset);
    }

	function allReady() {

        _configureModule();

        ocr_wrapper = new Module.ocr_wrapper;

        var canvas = document.getElementById("canvas_ocr");
        var context = canvas.getContext('2d');
        var image = new Image();

        image.onload=function(){

            canvas.width = image.naturalWidth;
            canvas.height = image.naturalHeight;

            console.log( 'natural image size is ' + image.naturalWidth + 'x' + image.naturalHeight );

            context.drawImage(image,0,0,canvas.width,canvas.height);

            var numBytes = canvas.width * canvas.height * 4;
            var ptr = Module._malloc(numBytes);
            var dataTrg = new Uint8Array(Module.HEAPU8.buffer, ptr, numBytes);

            var dataSrc = context.getImageData(0,0,canvas.width,canvas.height);
            var dataTrg = _arrayToHeap(dataSrc.data);

            var image_infos = { ptr : dataTrg.byteOffset, sizeX : canvas.width, sizeY : canvas.height };

            console.log('processing...');

            ocr_wrapper.process(image_infos,onProcessed);
            ocr_wrapper.delete();

            _freeArray(dataTrg);
        };
        image.src = "123456.png";
	}

    function onProcessed() {
        console.log('processed!');
        var rec = ocr_wrapper.reco_string();
        console.log('found ' + rec);
        document.getElementById('digits').innerHTML = 'might be ' + rec + '!';
    }

	</script>
</body>
</html>
